# 📊 系統改進總結報告

## 🎯 改進概述

本次更新為 AI 金融交易系統添加了**模型決策解釋功能**和**系統化的參數調整框架**，讓使用者能夠：

1. ✅ **理解模型決策邏輯** - 知道哪些技術指標促使模型做出買入/賣出決定
2. ✅ **系統化調整參數** - 透過配置類別集中管理所有超參數
3. ✅ **優化交易策略** - 可調整買賣門檻、倉位管理等策略參數
4. ✅ **視覺化決策過程** - 終端機輸出清晰的決策分析報告

---

## 🆕 核心新增功能

### 1. 決策解釋器 (`explain_prediction`)

**功能**：透過特徵敏感度分析，解釋模型為何做出特定預測。

**實現方式**：
- 計算每個特徵微擾後對預測的影響
- 顯示到各類別原型的距離
- 排序並展示最重要的影響因素

**輸出範例**：
```
⭐ 關鍵影響因素（前5名）：
   1. LogReturn_5          =   0.0234
      敏感度: +0.0123 ↑ 推動決策
   
   2. RSI                  =   0.6789
      敏感度: +0.0089 ↑ 推動決策
   
   3. Momentum_10          =  12.3450
      敏感度: +0.0067 ↑ 推動決策
```

**使用場景**：
- 每日推論時了解買賣建議的原因
- 驗證模型是否學到合理的市場模式
- 輔助人工決策判斷

---

### 2. 配置管理系統 (`TradingConfig`)

**功能**：集中管理所有可調參數，支持快速實驗。

**包含參數**：
```python
class TradingConfig:
    # 模型架構
    EMBEDDING_DIM = 20
    HIDDEN_DIMS = (128, 64, 32)
    DROPOUT = 0.15
    
    # 訓練設定
    LEARNING_RATE = 1e-3
    EPOCHS = 50
    EPISODES_PER_EPOCH = 80
    K_SHOT = 5
    Q_QUERY = 12
    TEMPERATURE = 0.8
    
    # 交易策略
    BUY_THRESHOLD = 0.005
    HOLD_THRESHOLD = 0.002
    SELL_THRESHOLD = -0.003
    
    # 特徵工程
    RSI_PERIOD = 14
    SMA_PERIOD = 20
    LOG_RETURN_PERIODS = [5, 10, 20, 30]
```

**優勢**：
- 一處修改，全局生效
- 易於版本控制和實驗比較
- 清晰的參數說明和建議範圍

---

### 3. 增強的訓練評估

**改進內容**：
- 訓練時自動顯示配置信息
- 評估時展示決策解釋範例
- 針對買入、賣出、持有各信號各展示一個案例

**輸出範例**：
```
開始訓練 2330.TW 的模型...
使用配置：embedding_dim=20, hidden=(128, 64, 32), dropout=0.15, lr=0.001, epochs=50

類別分布：
  賣出/觀望 (類別0):  245 筆 ( 35.21%)
  持有 (類別1):  312 筆 ( 44.83%)
  買入 (類別2):  139 筆 ( 19.97%)

...

📊 決策解釋範例（最近3筆交易信號）
======================================================================

▶ 買入信號 - 日期: 2024-11-15
  預測: 買入
  信心度: 買入=68.3%, 持有=22.1%, 賣出=9.6%
  
  關鍵影響因素（前5名）：
    1. LogReturn_5         =   0.0234  (敏感度: +0.0123) - 推動決策
    ...
```

---

### 4. 增強的每日推論

**改進內容**：
- 使用表情符號和視覺化元素
- 詳細的決策分析區塊
- 技術指標解讀（超買/超賣/中性）
- 可選擇性開啟/關閉解釋功能

**使用方式**：
```python
# 完整解釋
daily_inference('2330.TW', 'model_2330.pkl', enable_explanation=True)

# 僅顯示預測
daily_inference('2330.TW', 'model_2330.pkl', enable_explanation=False)
```

---

## 📈 模型可調整方向

### 方向 1：提升模型容量（捕捉更複雜模式）

**調整建議**：
```python
config.EMBEDDING_DIM = 32        # 20 → 32
config.HIDDEN_DIMS = (256, 128, 64)  # 增加層數
config.EPOCHS = 60               # 50 → 60
```

**預期效果**：
- ✅ 提升準確率 2-5%
- ✅ 更好地捕捉非線性關係
- ⚠️ 訓練時間增加 50-100%
- ⚠️ 可能過擬合（需搭配增加 Dropout）

---

### 方向 2：防止過擬合（提升泛化能力）

**調整建議**：
```python
config.DROPOUT = 0.25            # 0.15 → 0.25
config.EMBEDDING_DIM = 16        # 20 → 16
config.LEARNING_RATE = 5e-4      # 1e-3 → 5e-4
```

**預期效果**：
- ✅ 測試集表現更穩定
- ✅ 減少訓練/測試準確率差距
- ⚠️ 訓練準確率可能略降
- ⚠️ 需要更多訓練輪數

---

### 方向 3：調整交易策略（優化報酬/風險）

**保守策略**（降低交易頻率，提高勝率）：
```python
config.BUY_THRESHOLD = 0.008     # 0.005 → 0.008
config.SELL_THRESHOLD = -0.005   # -0.003 → -0.005
config.TEMPERATURE = 1.2         # 0.8 → 1.2
```

**預期效果**：
- ✅ 交易次數減少 30-50%
- ✅ 單筆交易勝率提升
- ✅ 最大回撤降低
- ⚠️ 總報酬可能略降

**激進策略**（增加交易頻率）：
```python
config.BUY_THRESHOLD = 0.003     # 0.005 → 0.003
config.SELL_THRESHOLD = -0.002   # -0.003 → -0.002
config.TEMPERATURE = 0.5         # 0.8 → 0.5
```

**預期效果**：
- ✅ 捕捉更多交易機會
- ✅ 潛在總報酬提升
- ⚠️ 交易次數增加（手續費增加）
- ⚠️ 最大回撤可能增加

---

### 方向 4：特徵工程優化

**新增技術指標**：
```python
# 在 engineer_features() 中添加

# MACD（趨勢動能）
df['MACD'] = df['Close'].ewm(span=12).mean() - df['Close'].ewm(span=26).mean()
df['MACD_Signal'] = df['MACD'].ewm(span=9).mean()

# 布林通道（波動範圍）
df['BB_Upper'] = df['SMA_20'] + 2 * df['Close'].rolling(20).std()
df['BB_Lower'] = df['SMA_20'] - 2 * df['Close'].rolling(20).std()
df['BB_Position'] = (df['Close'] - df['BB_Lower']) / (df['BB_Upper'] - df['BB_Lower'])

# Stochastic（動量震盪）
low_14 = df['Low'].rolling(14).min()
high_14 = df['High'].rolling(14).max()
df['Stochastic'] = (df['Close'] - low_14) / (high_14 - low_14)
```

**預期效果**：
- ✅ 提供更多市場信息
- ✅ 可能提升 3-8% 準確率
- ⚠️ 特徵維度增加（需注意過擬合）
- ⚠️ 計算時間略增

---

## 🔍 決策解釋系統使用指南

### 理解輸出指標

#### 1. 原型距離
```
📊 到各類別原型的距離：
   到類別0(賣出/觀望)距離: 0.5234
   到類別1(持有)距離: 0.3891
   到類別2(買入)距離: 0.1567  ← 最近！
```

**含義**：
- 模型將資料映射到嵌入空間
- 計算到三個類別原型的歐氏距離
- **距離越小 = 越接近該類別**

**應用**：
- 如果最小距離與次小距離很接近 → 決策不確定，建議保守
- 如果最小距離遠小於其他 → 決策信心高

#### 2. 特徵敏感度
```
⭐ 關鍵影響因素（前5名）：
   1. LogReturn_5          =   0.0234
      敏感度: +0.0123 ↑ 推動決策
```

**含義**：
- 對特徵值進行微小擾動（+0.01）
- 觀察到預測類別原型的距離變化
- **正敏感度** = 增大該特徵會推離當前預測
- **負敏感度** = 增大該特徵會靠近當前預測

**實際例子**：
假設預測為「買入」，`LogReturn_5` 敏感度為 +0.0123：
- 這表示 5 日收益率當前為正（0.0234）
- 若收益率再增大，模型會更不確定（距離增加）
- 但當前值已足夠讓模型做出買入決策

#### 3. 推動/抑制決策
```
推動決策：該特徵支持當前預測
抑制決策：該特徵反對當前預測
```

---

## 📋 實驗流程建議

### Step 1：建立基準
```python
# 使用預設配置運行
python "Final report.py"

# 記錄基準指標：
# - 準確率：____%
# - 總報酬率：____%
# - 最大回撤：____%
# - 交易次數：____次
```

### Step 2：單變量實驗
```python
# 實驗 1：測試不同 Embedding 維度
for dim in [16, 20, 24, 32]:
    config = TradingConfig()
    config.EMBEDDING_DIM = dim
    # 運行並記錄結果

# 實驗 2：測試不同 Dropout
for dropout in [0.1, 0.15, 0.2, 0.25]:
    config = TradingConfig()
    config.DROPOUT = dropout
    # 運行並記錄結果

# 實驗 3：測試不同買賣門檻
for buy_th in [0.003, 0.005, 0.008]:
    config = TradingConfig()
    config.BUY_THRESHOLD = buy_th
    # 運行並記錄結果
```

### Step 3：組合最佳參數
```python
best_config = TradingConfig()
best_config.EMBEDDING_DIM = 24      # 從實驗 1 得出
best_config.DROPOUT = 0.2           # 從實驗 2 得出
best_config.BUY_THRESHOLD = 0.006   # 從實驗 3 得出

# 運行並驗證
```

### Step 4：交叉驗證
```python
# 測試不同時間段
test_periods = [
    ('2023-01-01', '2023-12-31'),  # 2023年
    ('2024-01-01', '2024-06-30'),  # 2024上半年
    ('2024-07-01', '2024-12-31'),  # 2024下半年
]

for start, end in test_periods:
    # 使用 best_config 重新訓練並測試
    # 驗證模型穩健性
```

---

## 📊 預期改進效果（估計）

基於一般機器學習優化經驗，預期各方向的改進效果：

| 調整方向 | 準確率提升 | 報酬提升 | 回撤變化 | 訓練時間 |
|---------|----------|---------|---------|---------|
| 增加模型容量 | +2~5% | +3~8% | +1~2% | +50~100% |
| 防止過擬合 | +1~3% | +2~5% | -1~3% | +20~50% |
| 保守策略 | +0~2% | -5~0% | -3~5% | 無變化 |
| 激進策略 | -1~0% | +5~15% | +5~10% | 無變化 |
| 新增特徵 | +3~8% | +5~12% | ±2% | +10~30% |

**注意**：實際效果取決於市場環境和資料質量。

---

## 🎓 使用技巧

### 1. 解讀決策邏輯
```
✅ 好的決策：
- 多個高敏感度特徵同時推動決策
- 技術指標邏輯合理（如 RSI 超賣時建議買入）
- 到預測類別的距離明顯小於其他類別

⚠️ 需要警惕：
- 只有單一特徵主導決策
- 技術指標互相矛盾
- 到各類別距離都很接近（不確定性高）
```

### 2. 優化策略選擇
```
📊 如果當前問題是：
- 準確率低（<55%）→ 增加模型容量 + 新增特徵
- 過擬合（訓練準確率 >> 測試）→ 增加 Dropout + 降低容量
- 報酬率低但準確率可以 → 調整買賣門檻
- 回撤太大 → 保守策略 + 風險控制機制
```

### 3. 實驗記錄
建議使用以下格式記錄每次實驗：
```markdown
## 實驗 #01
**日期**: 2024-12-08
**目標**: 提升準確率
**變更**: EMBEDDING_DIM 20→32

**結果**:
- 準確率: 56.7% → 58.9% ✅
- 報酬率: 12.3% → 15.7% ✅
- 回撤: -8.2% → -9.5% ⚠️
- 訓練時間: 45s → 78s

**結論**: 
準確率和報酬提升明顯，但回撤略增。
建議保留並搭配增加 Dropout 到 0.2。

**下一步**: 實驗 #02 - 測試 DROPOUT=0.2
```

---

## 📁 文件結構

```
期末模組專題/
├── Final report.py           # 主程式（已更新）
├── 實驗調整指南.md            # 詳細參數調整說明
├── 快速使用指南.md            # 快速上手指南
├── README_改進總結.md         # 本文件
├── model_2330.pkl           # 台積電模型
├── model_2317.pkl           # 鴻海模型
└── model_2603.pkl           # 長榮模型
```

---

## ✅ 下一步行動

### 立即可做：
1. ☐ 運行主程式查看決策解釋效果
2. ☐ 測試每日推論功能 `daily_inference()`
3. ☐ 閱讀 `實驗調整指南.md` 了解參數含義

### 短期實驗：
4. ☐ 嘗試調整 `EMBEDDING_DIM` 到 24 或 32
5. ☐ 嘗試 `BUY_THRESHOLD = 0.008` 觀察交易頻率變化
6. ☐ 記錄基準指標與實驗結果

### 中期優化：
7. ☐ 在 `engineer_features()` 添加 MACD 和布林通道
8. ☐ 實作動態門檻機制（依 ATR 調整）
9. ☐ 添加倉位管理策略

---

## 🎉 總結

本次更新為系統添加了：

✅ **透明化** - 模型決策不再是黑盒子  
✅ **可控性** - 集中配置便於調參實驗  
✅ **實用性** - 每日推論提供清晰的操作建議  
✅ **擴展性** - 預留優化方向和實驗框架  

現在您可以：
- 理解每個買賣決策背後的技術指標邏輯
- 系統化地調整參數以優化模型表現
- 通過決策解釋驗證模型的合理性
- 快速進行參數實驗和效果比較

**祝實驗順利，交易獲利！** 📈💰🚀
