# 🎯 AI 金融交易系統 - 實驗調整指南

## 📋 目錄
1. [模型超參數優化](#模型超參數優化)
2. [特徵工程改進](#特徵工程改進)
3. [交易策略優化](#交易策略優化)
4. [決策解釋系統](#決策解釋系統)
5. [實驗建議](#實驗建議)

---

## 🔧 模型超參數優化

### 1. Embedding 維度 (`EMBEDDING_DIM`)
```python
# 當前值：20
TradingConfig.EMBEDDING_DIM = 20

# 調整建議：
- 較小值 (8-12)：訓練快，防止過擬合，適合資料少時
- 標準值 (16-24)：平衡表現與速度
- 較大值 (32-64)：表徵能力強，但需更多資料，易過擬合
```

**實驗方向**：
- ✅ 提高到 32 看準確率是否提升
- ✅ 降低到 12 測試是否過擬合減少

### 2. 隱藏層架構 (`HIDDEN_DIMS`)
```python
# 當前值：(128, 64, 32) - 三層遞減
TradingConfig.HIDDEN_DIMS = (128, 64, 32)

# 調整建議：
- 淺層快速：(64, 32) 或 (32, 16)
- 當前標準：(128, 64, 32)
- 深層強大：(256, 128, 64, 32) 或 (512, 256, 128)
```

**實驗方向**：
- ✅ 嘗試 `(256, 128, 64)` 看是否捕捉更複雜模式
- ✅ 嘗試 `(64, 32)` 降低過擬合風險

### 3. Dropout 率 (`DROPOUT`)
```python
# 當前值：0.15
TradingConfig.DROPOUT = 0.15

# 調整建議：
- 無正則化：0.0
- 輕度正則化：0.05-0.1
- 標準正則化：0.1-0.2
- 強力正則化：0.2-0.4
```

**實驗方向**：
- ✅ 如果訓練準確率 >> 測試準確率，提高到 0.25
- ✅ 如果兩者都低，降低到 0.05

### 4. 學習率 (`LEARNING_RATE`)
```python
# 當前值：1e-3 (0.001)
TradingConfig.LEARNING_RATE = 1e-3

# 調整建議：
- 保守：1e-4 或 5e-4（穩定但慢）
- 標準：1e-3（當前值）
- 激進：5e-3 或 1e-2（快但可能不穩定）
```

**實驗方向**：
- ✅ 若訓練初期 loss 震盪，降低到 5e-4
- ✅ 若收斂太慢，提高到 5e-3

### 5. 訓練輪數與 Episodes (`EPOCHS`, `EPISODES_PER_EPOCH`)
```python
# 當前值
TradingConfig.EPOCHS = 50
TradingConfig.EPISODES_PER_EPOCH = 80

# 調整建議：
- 快速測試：epochs=20, episodes=40
- 標準訓練：epochs=40-60, episodes=60-100
- 充分訓練：epochs=80-100, episodes=100-150
```

**實驗方向**：
- ✅ 觀察訓練曲線，若提前收斂可減少輪數
- ✅ 若仍在改善可增加到 80 epochs

### 6. Temperature (`TEMPERATURE`)
```python
# 當前值：0.8
TradingConfig.TEMPERATURE = 0.8

# 調整建議：
- 銳利決策：0.5-0.7（更自信的預測）
- 標準：0.8-1.0
- 平滑決策：1.2-2.0（更保守，機率分散）
```

**實驗方向**：
- ✅ 若要更果斷的買賣信號，降低到 0.5
- ✅ 若要減少激進交易，提高到 1.2

---

## 📊 特徵工程改進

### 1. 技術指標週期調整
```python
# 當前配置
TradingConfig.RSI_PERIOD = 14
TradingConfig.SMA_PERIOD = 20
TradingConfig.ATR_PERIOD = 14
TradingConfig.LOG_RETURN_PERIODS = [5, 10, 20, 30]

# 調整建議：
- 短線交易：RSI=7, SMA=10, 收益=[3, 5, 10]
- 中線交易：RSI=14, SMA=20, 收益=[5, 10, 20] (當前)
- 長線交易：RSI=21, SMA=60, 收益=[10, 20, 60]
```

### 2. 新增技術指標建議
```python
# 可在 engineer_features() 中添加：

# 1. MACD (趨勢動能)
df['MACD'] = df['Close'].ewm(span=12).mean() - df['Close'].ewm(span=26).mean()
df['MACD_Signal'] = df['MACD'].ewm(span=9).mean()

# 2. 布林通道 (波動範圍)
df['BB_Upper'] = df['SMA_20'] + 2 * df['Close'].rolling(20).std()
df['BB_Lower'] = df['SMA_20'] - 2 * df['Close'].rolling(20).std()
df['BB_Position'] = (df['Close'] - df['BB_Lower']) / (df['BB_Upper'] - df['BB_Lower'])

# 3. 動量震盪指標 (Stochastic)
low_14 = df['Low'].rolling(14).min()
high_14 = df['High'].rolling(14).max()
df['Stochastic'] = (df['Close'] - low_14) / (high_14 - low_14)

# 4. 資金流量指標 (MFI)
typical_price = (df['High'] + df['Low'] + df['Close']) / 3
money_flow = typical_price * df['Volume']
# ... (需要進一步計算正負資金流)
```

### 3. 特徵選擇與降維
```python
# 使用 SHAP 或特徵重要性分析
# 移除低貢獻度特徵可能提升模型效果

from sklearn.feature_selection import mutual_info_classif

# 計算特徵與目標的互信息
importance = mutual_info_classif(X_train, y_train)
# 只保留前 N 個重要特徵
```

---

## 💰 交易策略優化

### 1. 買賣門檻調整
```python
# 當前配置
TradingConfig.BUY_THRESHOLD = 0.005    # 0.5%
TradingConfig.HOLD_THRESHOLD = 0.002   # 0.2%
TradingConfig.SELL_THRESHOLD = -0.003  # -0.3%

# 調整建議：

# 保守策略（減少交易頻率）
BUY_THRESHOLD = 0.008   # 預期漲 0.8% 才買
SELL_THRESHOLD = -0.005 # 預期跌 0.5% 才賣

# 激進策略（增加交易頻率）
BUY_THRESHOLD = 0.003   # 預期漲 0.3% 就買
SELL_THRESHOLD = -0.002 # 預期跌 0.2% 就賣

# 動態門檻（根據波動率調整）
threshold = ATR * 0.5  # ATR 越高，門檻越高
```

### 2. 倉位管理
```python
# 當前：全倉進出（100% 或 0%）

# 改進建議：

# 1. 按信心度調整倉位
position_size = max_position * probability[prediction]

# 2. 金字塔加倉策略
if prediction == 2 and prob > 0.7:
    position_size = 0.5  # 先買 50%
elif prediction == 2 and prob > 0.85:
    position_size += 0.3  # 加碼 30%

# 3. 止損止盈機制
if current_loss > -0.05:  # 虧損 5% 強制出場
    sell_all()
if current_profit > 0.15:  # 獲利 15% 部分獲利了結
    sell(position * 0.5)
```

### 3. 風險控制
```python
# 添加到回測系統：

# 1. 最大回撤控制
if current_drawdown > MAX_DRAWDOWN_LIMIT:
    stop_trading()  # 暫停交易

# 2. 連續虧損保護
if consecutive_losses > 3:
    reduce_position_size *= 0.5

# 3. 單日最大虧損
if daily_loss > initial_capital * 0.02:
    close_all_positions()
```

---

## 🔍 決策解釋系統

### 使用方式

#### 1. 訓練時查看決策邏輯
```python
model = StockTradingModel('2330.TW')
X_train, X_test, y_train, y_test, _, test_data = model.prepare_data(data)

# 訓練時會自動顯示決策解釋範例
model.train(X_train, y_train, config=TradingConfig())
y_pred, y_pred_proba, accuracy = model.evaluate(X_test, y_test, enable_explanation=True)
```

輸出範例：
```
📊 決策解釋範例（最近3筆交易信號）
======================================================================

▶ 買入信號 - 日期: 2024-03-15
  預測: 買入
  信心度: 買入=72.3%, 持有=18.9%, 賣出=8.8%

  關鍵影響因素（前5名）：
    1. LogReturn_5         =   0.0234  (敏感度: +0.0123) - 推動決策
    2. RSI                 =   0.6789  (敏感度: +0.0089) - 推動決策
    3. Momentum_10         =  12.3450  (敏感度: +0.0067) - 推動決策
    4. SMA_Deviation       =   0.0345  (敏感度: -0.0045) - 抑制決策
    5. Volume_Change       =   0.1567  (敏感度: +0.0034) - 推動決策
```

#### 2. 每日推論時查看決策原因
```python
# 查看今日建議並了解原因
result = daily_inference('2330.TW', 'model_2330.pkl', enable_explanation=True)
```

輸出範例：
```
🔍 決策分析：為什麼模型做出這個預測？
──────────────────────────────────────────────────────────────────

📊 到各類別原型的距離：
   到類別0(賣出/觀望)距離: 0.4521
   到類別1(持有)距離: 0.3876
   到類別2(買入)距離: 0.1234  ← 最近！

⭐ 關鍵影響因素（前5名）：
   1. LogReturn_5          =   0.0234
      敏感度: +0.0123 ↑ 推動決策
   
   2. RSI                  =   0.6789
      敏感度: +0.0089 ↑ 推動決策
   ...
```

### 理解指標含義

1. **到原型的距離**：越小表示越接近該類別
2. **敏感度**：
   - 正值 = 該特徵增大會使預測更不確定（推離當前類別）
   - 負值 = 該特徵增大會使預測更確定（推向當前類別）
3. **推動/抑制決策**：
   - 推動 = 該特徵支持當前預測
   - 抑制 = 該特徵反對當前預測

---

## 🧪 實驗建議流程

### 階段 1：基準測試
```python
# 使用當前配置運行，記錄：
# - 準確率
# - 總報酬率
# - 最大回撤
# - 交易次數
```

### 階段 2：單變量實驗
```python
# 每次只改一個參數，觀察影響

# 實驗 1: Embedding 維度
for dim in [12, 16, 20, 24, 32]:
    config = TradingConfig()
    config.EMBEDDING_DIM = dim
    # 訓練並記錄結果

# 實驗 2: Dropout
for dropout in [0.0, 0.1, 0.15, 0.2, 0.3]:
    config = TradingConfig()
    config.DROPOUT = dropout
    # 訓練並記錄結果
```

### 階段 3：最佳組合
```python
# 結合表現最好的參數
best_config = TradingConfig()
best_config.EMBEDDING_DIM = 24
best_config.DROPOUT = 0.2
best_config.LEARNING_RATE = 5e-4
best_config.EPOCHS = 60
# ...
```

### 階段 4：交叉驗證
```python
# 使用不同時間段測試穩健性
test_periods = [
    ('2023-01-01', '2023-12-31'),
    ('2024-01-01', '2024-06-30'),
    ('2024-07-01', '2024-12-31'),
]

for start, end in test_periods:
    # 重新訓練並測試
```

---

## 📈 預期改進方向

### 短期改進（容易實現）
1. ✅ 調整買賣門檻提高交易質量
2. ✅ 增加技術指標（MACD, BB）
3. ✅ 調整 embedding 維度和 dropout

### 中期改進（需要實驗）
1. 🔄 實作動態門檻機制
2. 🔄 添加倉位管理策略
3. 🔄 特徵選擇與降維

### 長期改進（需要架構改動）
1. 🎯 多時間框架融合（日線+週線）
2. 🎯 集成多個模型（ensemble）
3. 🎯 強化學習策略優化
4. 🎯 情緒指標與新聞分析

---

## 🎓 調參技巧

### 1. 過擬合診斷
```
症狀：訓練準確率 >> 測試準確率（差距 > 10%）
解決：增加 dropout、減少 embedding_dim、增加正則化
```

### 2. 欠擬合診斷
```
症狀：訓練準確率和測試準確率都很低（< 50%）
解決：增加模型容量（hidden_dims）、降低 dropout、增加訓練輪數
```

### 3. 不穩定訓練
```
症狀：loss 劇烈震盪、梯度爆炸
解決：降低學習率、增加 batch normalization、gradient clipping
```

### 4. 收斂太慢
```
症狀：loss 下降緩慢
解決：提高學習率、減少模型深度、warm-up 策略
```

---

## 📝 實驗記錄範本

```markdown
### 實驗 #01: 增加 Embedding 維度
**日期**: 2024-12-08
**配置變更**:
- EMBEDDING_DIM: 20 → 32
- 其他保持不變

**結果**:
- 準確率: 56.7% → 58.3% ✅
- 總報酬: 12.5% → 15.2% ✅
- 最大回撤: -8.3% → -9.1% ❌
- 訓練時間: 45s → 67s

**結論**: 
準確率和報酬提升，但回撤略增，訓練時間增加 50%。
建議保留此改動，並嘗試增加 dropout 以控制回撤。
```

---

## 🚀 快速開始

修改配置後運行：
```python
# 1. 修改 TradingConfig 類別中的參數
class TradingConfig:
    EMBEDDING_DIM = 24  # 改這裡
    DROPOUT = 0.2       # 改這裡
    # ...

# 2. 運行主程式
python "Final report.py"

# 3. 查看決策解釋
daily_inference('2330.TW', 'model_2330.pkl', enable_explanation=True)
```

祝實驗順利！🎉
