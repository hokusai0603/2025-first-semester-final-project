# 🎯 快速使用指南

## 運行主程式（訓練並測試所有股票）

```powershell
# 切換到專案目錄
cd "c:\Users\lcc04\Desktop\homework for an AI project\期末報告喔~\2025-first-semester-final-project\期末模組專題"

# 運行主程式
python "Final report.py"
```

## 查看單支股票的每日推論（含決策解釋）

```python
# 在 Python 中或腳本中運行

from Final report import daily_inference

# 台積電
daily_inference('2330.TW', 'model_2330.pkl', enable_explanation=True)

# 鴻海
daily_inference('2317.TW', 'model_2317.pkl', enable_explanation=True)

# 長榮
daily_inference('2603.TW', 'model_2603.pkl', enable_explanation=True)
```

## 調整模型參數（實驗優化）

### 方法 1：直接修改配置類別

在 `Final report.py` 中找到 `TradingConfig` 類別並修改參數：

```python
class TradingConfig:
    # 模型架構參數
    EMBEDDING_DIM = 24  # 修改這裡：從 20 改為 24
    HIDDEN_DIMS = (256, 128, 64)  # 修改這裡：增加層數
    DROPOUT = 0.2  # 修改這裡：增加 dropout
    
    # 訓練參數
    LEARNING_RATE = 5e-4  # 修改這裡：降低學習率
    EPOCHS = 60  # 修改這裡：增加訓練輪數
    
    # 交易策略參數
    BUY_THRESHOLD = 0.006  # 修改這裡：提高買入門檻（更保守）
    SELL_THRESHOLD = -0.004  # 修改這裡：明確賣出門檻
```

### 方法 2：創建自定義配置

```python
# 在主程式中

# 創建自定義配置
custom_config = TradingConfig()
custom_config.EMBEDDING_DIM = 32
custom_config.DROPOUT = 0.25
custom_config.LEARNING_RATE = 1e-4

# 使用自定義配置訓練
model = StockTradingModel('2330.TW')
X_train, X_test, y_train, y_test, train_data, test_data = model.prepare_data(data)
model.train(X_train, y_train, config=custom_config)
```

## 輸出範例

### 主程式輸出（含決策解釋）

```
================================================================================
🚀 AI 金融交易系統 - 台股 MVP 專案 (投資組合模式 + 決策解釋)
================================================================================

📊 當前系統配置：
--------------------------------------------------------------------------------
模型架構：Embedding=20, Hidden=(128, 64, 32), Dropout=0.15
訓練設定：LR=0.001, Epochs=50, Episodes=80
交易策略：買入門檻=0.50%, 賣出門檻=-0.30%
Few-Shot：K=5, Q=12, Temperature=0.8
--------------------------------------------------------------------------------
💡 如需調整參數以優化模型，請參閱 '實驗調整指南.md'

...

======================================================================
📊 決策解釋範例（最近3筆交易信號）
======================================================================

▶ 買入信號 - 日期: 2024-11-15
  預測: 買入
  信心度: 買入=68.3%, 持有=22.1%, 賣出=9.6%

  關鍵影響因素（前5名）：
    1. LogReturn_5         =   0.0234  (敏感度: +0.0123) - 推動決策
    2. RSI                 =   0.6234  (敏感度: +0.0089) - 推動決策
    3. Momentum_10         =  11.2340  (敏感度: +0.0067) - 推動決策
    4. SMA_Deviation       =   0.0289  (敏感度: +0.0045) - 推動決策
    5. Volume_Change       =   0.1456  (敏感度: +0.0034) - 推動決策

▶ 賣出信號 - 日期: 2024-11-20
  預測: 賣出/觀望
  信心度: 買入=12.4%, 持有=25.6%, 賣出=62.0%

  關鍵影響因素（前5名）：
    1. LogReturn_5         =  -0.0178  (敏感度: -0.0145) - 推動決策
    2. RSI                 =   0.2912  (敏感度: -0.0098) - 推動決策
    3. Momentum_20         = -15.6780  (敏感度: -0.0076) - 推動決策
    ...
```

### 每日推論輸出

```
======================================================================
📈 每日推論 - 2330.TW
執行時間：2024-12-08 15:30:45
======================================================================

📅 最新資料日期：2024-12-08
💰 收盤價：$945.00

🚀 預測結果：買入 (建議操作)
   買入機率:  72.3% ████████████████
   持有機率:  18.9% ████
   賣出機率:   8.8% ██

──────────────────────────────────────────────────────────────────
🔍 決策分析：為什麼模型做出這個預測？
──────────────────────────────────────────────────────────────────

📊 到各類別原型的距離：
   到類別0(賣出/觀望)距離: 0.5234
   到類別1(持有)距離: 0.3891
   到類別2(買入)距離: 0.1567  ← 最近！

⭐ 關鍵影響因素（前5名）：
   1. LogReturn_5          =   0.0234
      敏感度: +0.0123 ↑ 推動決策
   
   2. RSI                  =   0.6789
      敏感度: +0.0089 ↑ 推動決策
   
   3. Momentum_10          =  12.3450
      敏感度: +0.0067 ↑ 推動決策
   
   4. SMA_Deviation        =   0.0345
      敏感度: +0.0045 ↑ 推動決策
   
   5. Volume_Change        =   0.1567
      敏感度: +0.0034 ↑ 推動決策

──────────────────────────────────────────────────────────────────
📈 技術指標總覽：
──────────────────────────────────────────────────────────────────
   RSI (相對強弱)：67.89 ✅中性
   SMA乖離率：3.45% ➡️正常
   ATR標準化（波動）：0.0123
   5日對數收益：0.0234
   10日對數收益：0.0456
   20日對數收益：0.0789

======================================================================
```

## 理解決策解釋

### 1. 原型距離
- **含義**：模型將每筆資料嵌入到高維空間，計算其與三個類別原型的距離
- **解讀**：距離最小的類別即為預測結果
- **應用**：如果到所有原型的距離都很近，表示決策不確定

### 2. 敏感度分析
- **正敏感度 (+)**：該特徵增大會推離當前預測類別（使預測不確定）
- **負敏感度 (-)**：該特徵增大會靠近當前預測類別（使預測更確定）
- **絕對值大小**：表示該特徵對決策的影響程度

### 3. 推動/抑制決策
- **推動**：該特徵的當前值支持模型的預測
- **抑制**：該特徵的當前值與模型預測方向相反

## 實驗調整建議

詳細的參數調整指南請參閱 **`實驗調整指南.md`**，包含：

1. **模型超參數優化**
   - Embedding 維度 (8-64)
   - 隱藏層架構 ((64,32) ~ (512,256,128))
   - Dropout (0.0-0.4)
   - 學習率 (1e-4 ~ 1e-2)
   - 訓練輪數 (20-100)

2. **特徵工程改進**
   - 新增 MACD、布林通道、Stochastic 等指標
   - 調整技術指標週期
   - 特徵選擇與降維

3. **交易策略優化**
   - 買賣門檻調整（保守 vs 激進）
   - 倉位管理策略
   - 風險控制機制

## 常見問題

### Q1: 如何提高模型準確率？
**A**: 
1. 增加 `EMBEDDING_DIM` 到 24-32
2. 增加訓練輪數 `EPOCHS` 到 60-80
3. 添加更多技術指標（參考指南）
4. 調整門檻值使其更符合市場特性

### Q2: 模型過擬合怎麼辦？
**A**:
1. 提高 `DROPOUT` 到 0.2-0.3
2. 減少 `EMBEDDING_DIM`
3. 使用更多訓練資料
4. 增加正則化

### Q3: 如何降低交易頻率？
**A**:
1. 提高 `BUY_THRESHOLD` (例如從 0.005 到 0.008)
2. 降低 `SELL_THRESHOLD` (例如從 -0.003 到 -0.005)
3. 增加 `HOLD_THRESHOLD` 範圍

### Q4: 決策解釋顯示的敏感度如何應用？
**A**:
- 高敏感度特徵是關鍵決策因子
- 可用於驗證模型是否學到合理模式
- 幫助判斷預測信心度
- 輔助手動決策

## 進階使用

### 批量實驗比較

```python
# 創建多個配置並比較
configs = {
    '標準配置': TradingConfig(),
    '高容量配置': TradingConfig(),
    '保守配置': TradingConfig(),
}

configs['高容量配置'].EMBEDDING_DIM = 32
configs['高容量配置'].HIDDEN_DIMS = (256, 128, 64)

configs['保守配置'].BUY_THRESHOLD = 0.008
configs['保守配置'].DROPOUT = 0.25

results = {}
for name, config in configs.items():
    print(f"\n測試配置：{name}")
    # 訓練並記錄結果
    # ...
```

### 自定義特徵

```python
# 在 engineer_features() 函數中添加

def engineer_features(data, use_advanced=False):
    df = data.copy()
    
    # 原有特徵 ...
    
    if use_advanced:
        # MACD
        df['MACD'] = df['Close'].ewm(span=12).mean() - df['Close'].ewm(span=26).mean()
        df['MACD_Signal'] = df['MACD'].ewm(span=9).mean()
        df['MACD_Hist'] = df['MACD'] - df['MACD_Signal']
        
        # 布林通道
        df['BB_Upper'] = df['SMA_20'] + 2 * df['Close'].rolling(20).std()
        df['BB_Lower'] = df['SMA_20'] - 2 * df['Close'].rolling(20).std()
        df['BB_Width'] = (df['BB_Upper'] - df['BB_Lower']) / df['SMA_20']
    
    return df
```

---

**祝您交易順利！**📈💰
